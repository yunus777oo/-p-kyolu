<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traffic Rider - Pro</title>
    <style>
        :root {
            --road-color: #3a3a3a;
            --grass-color: #2e7d32;
            --line-color: rgba(255, 255, 255, 0.8);
        }

        body {
            margin: 0;
            height: 100vh;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background-color: var(--road-color);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-left: 15px solid var(--grass-color);
            border-right: 15px solid var(--grass-color);
        }

        #road {
            position: absolute; width: 100%; height: 100%;
        }

        .road-line {
            position: absolute; width: 8px; height: 120px;
            background: var(--line-color); left: 50%;
            transform: translateX(-50%);
        }

        #line-double-left { left: calc(50% - 6px); background: #ffeb3b; width: 4px; height: 100%; position: absolute; }
        #line-double-right { left: calc(50% + 6px); background: #ffeb3b; width: 4px; height: 100%; position: absolute; }
        #line-dashed-left { left: 25%; width: 6px; background: transparent; border-left: 6px dashed rgba(255,255,255,0.4); height: 100%; position: absolute;}
        #line-dashed-right { left: 75%; width: 6px; background: transparent; border-left: 6px dashed rgba(255,255,255,0.4); height: 100%; position: absolute;}

        .car {
            position: absolute;
            width: 50px; 
            height: 90px;
            z-index: 10;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: red; 
            border-radius: 5px;
        }

        #player-car {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2196F3;
        }

        .enemy-car {
            z-index: 5;
            background-color: #ff5722;
        }

        .enemy-car.opposite {
            transform: rotate(180deg);
            background-color: #e91e63;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }

        .hud-panel {
            position: absolute;
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #score-box { top: 20px; left: 20px; color: #ffeb3b; }
        #multiplier-box { top: 55px; left: 20px; color: #f44336; font-size: 12px; display: none; }
        #speed-box { top: 20px; right: 20px; font-size: 20px; }
        
        #speed-bar {
            position: absolute; top: 60px; right: 20px;
            width: 80px; height: 6px; background: #333;
            border-radius: 3px; overflow: hidden;
        }
        #speed-fill { width: 0%; height: 100%; background: linear-gradient(90deg, lime, red); }

        .touch-control {
            position: absolute;
            bottom: 0;
            height: 50%; 
            z-index: 150;
            pointer-events: auto;
        }

        #touch-left { left: 0; width: 40%; }
        #touch-right { right: 0; width: 40%; }
        #touch-center { left: 40%; width: 20%; bottom: 0; height: 30%; }

        .notification {
            position: absolute; left: 50%; top: 40%;
            transform: translate(-50%, -50%);
            font-size: 20px; font-weight: bold; color: #ffeb3b;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            opacity: 0; transition: 0.3s;
        }

        #game-over-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 200;
        }

        button {
            margin-top: 20px; padding: 15px 40px;
            background: #4CAF50; color: white; border: none;
            border-radius: 30px; font-size: 18px; cursor: pointer;
        }

        .shake { animation: shake 0.3s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, -1px); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="road">
            <div id="line-dashed-left"></div>
            <div id="line-double-left"></div>
            <div id="line-double-right"></div>
            <div id="line-dashed-right"></div>
        </div>

        <div id="player-car" class="car"></div>

        <div id="touch-left" class="touch-control"></div>
        <div id="touch-right" class="touch-control"></div>
        <div id="touch-center" class="touch-control"></div>

        <div id="ui-layer">
            <div id="score-box" class="hud-panel">XAL: 0</div>
            <div id="multiplier-box" class="hud-panel">ƏKS YOL: 3x XAL!</div>
            <div id="speed-box" class="hud-panel">0 KM/H</div>
            <div id="speed-bar"><div id="speed-fill"></div></div>
            <div id="notification" class="notification"></div>
        </div>

        <div id="game-over-screen">
            <h1 style="color: white;">QƏZA!</h1>
            <div style="color: #ffeb3b; font-size: 24px;">XAL: <span id="end-score">0</span></div>
            <button id="restart-btn">BAŞLA</button>
        </div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const playerCar = document.getElementById('player-car');
        const scoreEl = document.getElementById('score-box');
        const multEl = document.getElementById('multiplier-box');
        const speedEl = document.getElementById('speed-box');
        const speedFill = document.getElementById('speed-fill');
        const gameOverScreen = document.getElementById('game-over-screen');
        const endScoreEl = document.getElementById('end-score');
        const restartBtn = document.getElementById('restart-btn');
        const road = document.getElementById('road');

        const GAME_WIDTH = container.offsetWidth;
        const CAR_WIDTH = 50;
        const MAX_SPEED = 200;
        
        let state = {
            running: false,
            speed: 0,
            x: 250 - 25,
            score: 0,
            highScore: localStorage.getItem('tr_high') || 0
        };

        let keys = {};
        let enemies = [];
        let roadLines = [];
        let lastTime = 0;
        let enemySpawnTimer = 0;

        function setKey(k, v) { keys[k] = v; }

        window.addEventListener('keydown', e => setKey(e.key.toLowerCase(), true));
        window.addEventListener('keyup', e => setKey(e.key.toLowerCase(), false));

        document.getElementById('touch-left').addEventListener('touchstart', e => { e.preventDefault(); setKey('a', true); setKey('w', true); });
        document.getElementById('touch-left').addEventListener('touchend', e => { e.preventDefault(); setKey('a', false); });
        
        document.getElementById('touch-right').addEventListener('touchstart', e => { e.preventDefault(); setKey('d', true); setKey('w', true); });
        document.getElementById('touch-right').addEventListener('touchend', e => { e.preventDefault(); setKey('d', false); });

        document.getElementById('touch-center').addEventListener('touchstart', e => { e.preventDefault(); setKey('w', true); });
        document.getElementById('touch-center').addEventListener('touchend', e => { e.preventDefault(); setKey('w', false); });

        function initRoad() {
            for(let i=0; i<8; i++) {
                let div = document.createElement('div');
                div.className = 'road-line';
                div.style.top = (i * 150) + 'px';
                road.appendChild(div);
                roadLines.push({ el: div, y: i * 150 });
            }
        }
        initRoad();

        function startGame() {
            state.running = true;
            state.speed = 0;
            state.score = 0;
            state.x = container.offsetWidth / 2 - 25;
            enemies.forEach(en => en.el.remove());
            enemies = [];
            gameOverScreen.style.display = 'none';
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function gameLoop(time) {
            if(!state.running) return;
            let delta = (time - lastTime) / 16;
            lastTime = time;

            updatePhysics(delta);
            updateRoad(delta);
            updateEnemies(delta);
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics(delta) {
            if (keys['w'] || keys['arrowup']) state.speed += 0.5 * delta;
            else state.speed -= 0.3 * delta;

            if (state.speed < 0) state.speed = 0;
            if (state.speed > MAX_SPEED) state.speed = MAX_SPEED;

            if (keys['a'] || keys['arrowleft']) state.x -= 5 * delta;
            if (keys['d'] || keys['arrowright']) state.x += 5 * delta;

            let limit = 15;
            if (state.x < limit) state.x = limit;
            if (state.x > container.offsetWidth - CAR_WIDTH - limit) state.x = container.offsetWidth - CAR_WIDTH - limit;

            playerCar.style.left = state.x + 'px';

            let isOppositeWay = state.x < (container.offsetWidth / 2) - 10;
            let multiplier = isOppositeWay ? 3 : 1;
            
            multEl.style.display = isOppositeWay ? 'block' : 'none';

            if (state.speed > 10) {
                state.score += (state.speed * 0.01 * multiplier) * delta;
            }
        }

        function updateRoad(delta) {
            let move = state.speed * 0.2 * delta;
            roadLines.forEach(l => {
                l.y += move;
                if(l.y > window.innerHeight) l.y = -150;
                l.el.style.top = l.y + 'px';
            });
        }

        function updateEnemies(delta) {
            enemySpawnTimer -= delta;
            if(enemySpawnTimer <= 0) {
                spawnEnemy();
                enemySpawnTimer = Math.max(20, 100 - (state.speed / 2));
            }

            enemies.forEach((en, i) => {
                let speedBase = state.speed * 0.2;
                let finalMove = en.opposite ? (speedBase + 5) : (speedBase - 3);
                en.y += finalMove * delta;
                en.el.style.top = en.y + 'px';

                if(en.y > window.innerHeight) {
                    en.el.remove();
                    enemies.splice(i, 1);
                }

                if(checkCollision(en)) endGame();
            });
        }

        function spawnEnemy() {
            let lane = Math.floor(Math.random() * 4);
            let opposite = lane < 2;
            let div = document.createElement('div');
            div.className = 'car enemy-car' + (opposite ? ' opposite' : '');
            let xPos = (lane * (container.offsetWidth / 4)) + 20;
            div.style.left = xPos + 'px';
            div.style.top = '-100px';
            road.appendChild(div);
            enemies.push({ el: div, x: xPos, y: -100, opposite: opposite });
        }

        function checkCollision(en) {
            let pRect = playerCar.getBoundingClientRect();
            let eRect = en.el.getBoundingClientRect();
            return !(pRect.right < eRect.left + 5 || pRect.left > eRect.right - 5 || pRect.bottom < eRect.top + 5 || pRect.top > eRect.bottom - 5);
        }

        function updateUI() {
            scoreEl.innerText = `XAL: ${Math.floor(state.score)}`;
            speedEl.innerText = `${Math.floor(state.speed)} KM/H`;
            speedFill.style.width = (state.speed / MAX_SPEED * 100) + '%';
        }

        function endGame() {
            state.running = false;
            endScoreEl.innerText = Math.floor(state.score);
            gameOverScreen.style.display = 'flex';
        }

        restartBtn.addEventListener('click', startGame);
        startGame();
    </script>
</body>
</html>
